{% extends "base.html" %}

{% block title %}SOAP Builder{% endblock %}

{% block head %}
<style>
  fieldset { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; }
  legend { font-weight: bold; }
  label { user-select: none; }
  table {
    border-collapse: collapse;
    width: 100%;
    font-family: Calibri, sans-serif;
    font-size: 11pt;
    margin-bottom: 1rem;
  }
  th, td {
    border: 1px solid black;
    padding: 6px;
    vertical-align: top;
  }
  th {
    font-weight: bold;
    text-align: left;
    white-space: nowrap;
  }
  input[type="text"] {
    width: 150px;
    font-family: Calibri, sans-serif;
    font-size: 11pt;
  }
  textarea {
    width: 100%;
    height: 120px;
    margin-top: 10px;
    font-family: Calibri, sans-serif;
    font-size: 11pt;
  }
  .btn-row {
    display: flex;
    justify-content: flex-start;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
  }
  button {
    padding: 8px 15px;
    cursor: pointer;
  }
  .status-text {
    font-style: italic;
    color: #555;
    font-size: 0.9em;
  }
  .checkbox-label {
    margin-right: 1em;
  }
</style>
{% endblock %}

{% block content %}
<h1>SOAP Builder</h1>

<!-- Therapist Category -->
<fieldset>
  <legend>Therapist</legend>
  <div>
    <label class="checkbox-label"><input type="checkbox" name="therapist" value="PT" /> PT</label>
    <label class="checkbox-label"><input type="checkbox" name="therapist" value="OT" /> OT</label>
  </div>
</fieldset>

<!-- Subjective Table -->
<fieldset>
  <legend>Subjective</legend>
  <table>
    <tr>
      <th>Patient:</th>
      <td>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Pt states" /> Pt states</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Pt reports" /> Pt reports</label>
      </td>
      <th>Sides:</th>
      <td>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Right" /> Right</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Left" /> Left</label>
      </td>
      <th>Pain:</th>
      <td>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Yes" /> Yes</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="No" /> No</label>
      </td>
    </tr>
    <tr>
      <th>Location:</th>
      <td colspan="5">
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Neck" /> Neck</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Shoulder" /> Shoulder</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Arm" /> Arm</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Elbow" /> Elbow</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Wrist" /> Wrist</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Hand" /> Hand</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Mid Back" /> Mid Back</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Low Back" /> Low Back</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Hip" /> Hip</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Thigh" /> Thigh</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Knee" /> Knee</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Calves" /> Calves</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Ankle" /> Ankle</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Foot" /> Foot</label>
      </td>
    </tr>
    <tr>
      <th>Sensation:</th>
      <td colspan="5">
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Tension" /> Tension</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Dull pain" /> Dull pain</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Sharp Pain" /> Sharp Pain</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Ache Pain" /> Ache Pain</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Numbness" /> Numbness</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Tingle" /> Tingle</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Shooting" /> Shooting</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Throbbing" /> Throbbing</label>
        Other: <input type="text" name="subjective_sensation_other" />
      </td>
    </tr>
    <tr>
      <th>Feeling:</th>
      <td colspan="5">
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Tired" /> Tired</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Soreness" /> Soreness</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="In Different" /> In Different</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="No Changes" /> No Changes</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Eager" /> Eager</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Motivated" /> Motivated</label>
        Other: <input type="text" name="subjective_feeling_other" />
      </td>
    </tr>
    <tr>
      <th>Movement Limitations:</th>
      <td colspan="5">
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Sleeping" /> Sleeping</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Lying" /> Lying</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Sitting" /> Sitting</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Standing" /> Standing</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Walking" /> Walking</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Stairs/steps Negotiation" /> Stairs/steps Negotiation</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Forward Bending" /> Forward Bending</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="General Movement" /> General Movement</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Holding" /> Holding</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Gripping" /> Gripping</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Pulling" /> Pulling</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Pushing" /> Pushing</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Reach Behind" /> Reach Behind</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Reach Above" /> Reach Above</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Immobility" /> Immobility</label>
      </td>
    </tr>
    <tr>
      <th>Activity Limitations:</th>
      <td colspan="5">
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Cooking" /> Cooking</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Cleaning Grooming" /> Cleaning Grooming</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Dressing" /> Dressing</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Brushing" /> Brushing</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Gardening" /> Gardening</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Laundry" /> Laundry</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Sweeping" /> Sweeping</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Driving" /> Driving</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Gym" /> Gym</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Community" /> Community</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Participation" /> Participation</label>
        Other: <input type="text" name="subjective_activity_other" />
      </td>
    </tr>
    <tr>
      <th>Tolerance:</th>
      <td colspan="5">
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Symptom Decrease" /> Symptom Decrease</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Symptom Increase" /> Symptom Increase</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Improved" /> Improved</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Progressing" /> Progressing</label>
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="No Changes" /> No Changes</label>
      </td>
    </tr>
    <tr>
      <th>Consent:</th>
      <td colspan="5">
        <label class="checkbox-label"><input type="checkbox" name="subjective" value="Pt agrees to tx and POC today" /> Pt agrees to tx and POC today.</label>
      </td>
    </tr>
  </table>

  <textarea id="subjective-text" placeholder="Subjective Field: Final Text"></textarea>

  <div class="btn-row">
    <button id="generate-subjective-btn">AI Regenerate Subjective</button>
    <button id="copy-subjective-btn" type="button">Copy</button>
    <span id="subjective-status" class="status-text"></span>
  </div>
</fieldset>

<!-- Assessment Section -->
<fieldset>
  <legend>Assessment</legend>

  <strong>Assessment Categories:</strong>
  <div class="checkbox-group">
    <label><input type="checkbox" name="assessment" value="Tenderness with Palpation" /> Tenderness with Palpation</label>
    <label><input type="checkbox" name="assessment" value="pain with functional movement" /> pain with functional movement</label>
    <label><input type="checkbox" name="assessment" value="pain with sitting" /> pain with sitting</label>
    <label><input type="checkbox" name="assessment" value="Soft Tissue Restriction" /> Soft Tissue Restriction</label>
    <label><input type="checkbox" name="assessment" value="Myotension" /> Myotension</label>
  </div>

  <strong>Treatment Intervention:</strong>
  <div class="checkbox-group">
    <label><input type="checkbox" name="assessment" value="Manual Therapy" /> Manual Therapy</label>
    <label><input type="checkbox" name="assessment" value="Therapeutic Exercises" /> Therapeutic Exercises</label>
    <label><input type="checkbox" name="assessment" value="Therapeutic Activity" /> Therapeutic Activity</label>
    <label><input type="checkbox" name="assessment" value="Gait Training" /> Gait Training</label>
    <label><input type="checkbox" name="assessment" value="Neuromuscular Re-education" /> Neuromuscular Re-education</label>
    <label><input type="checkbox" name="assessment" value="Stretching" /> Stretching</label>
    <label><input type="checkbox" name="assessment" value="STM" /> STM</label>
    <label><input type="checkbox" name="assessment" value="Trigger Point Release" /> Trigger Point Release</label>
  </div>

  <strong>Tolerance:</strong>
  <div class="checkbox-group">
    <label><input type="checkbox" name="assessment" value="Good" /> Good</label>
    <label><input type="checkbox" name="assessment" value="Fair" /> Fair</label>
    <label><input type="checkbox" name="assessment" value="Poor" /> Poor</label>
  </div>

  <strong>Training Cues:</strong>
  <div class="checkbox-group">
    <label><input type="checkbox" name="assessment" value="Verbal Cue" /> Verbal Cue</label>
    <label><input type="checkbox" name="assessment" value="Tactile Cue" /> Tactile Cue</label>
    <label><input type="checkbox" name="assessment" value="Demonstration" /> Demonstration</label>
    <label><input type="checkbox" name="assessment" value="Education" /> Education</label>
  </div>

  <strong>Outcome:</strong>
  <div class="checkbox-group">
    <label><input type="checkbox" name="assessment" value="Acknowledge" /> Acknowledge</label>
    <label><input type="checkbox" name="assessment" value="Comprehend" /> Comprehend</label>
    <label><input type="checkbox" name="assessment" value="Decrease Symptoms" /> Decrease Symptoms</label>
    <label><input type="checkbox" name="assessment" value="Pain Reduction" /> Pain Reduction</label>
    <label><input type="checkbox" name="assessment" value="Decrease Tension" /> Decrease Tension</label>
    <label><input type="checkbox" name="assessment" value="Decrease Tissue Restriction" /> Decrease Tissue Restriction</label>
    <label><input type="checkbox" name="assessment" value="Improved movement tolerance" /> Improved movement tolerance</label>
    <label><input type="checkbox" name="assessment" value="improve safety awareness" /> improve safety awareness</label>
  </div>

  <strong>Plan:</strong>
  <div class="checkbox-group">
    <label><input type="checkbox" name="assessment" value="Continue with tx to meet goals" /> Continue with tx to meet goals</label>
    <label><input type="checkbox" name="assessment" value="Need further treatment" /> Need further treatment</label>
    <label><input type="checkbox" name="assessment" value="Will continue to benefit" /> Will continue to benefit</label>
    <label><input type="checkbox" name="assessment" value="Essential to further improve and return to PLOF" /> Essential to further improve and return to PLOF</label>
  </div>

  <strong>Summary Length:</strong>
  <div class="checkbox-group">
    <label><input type="radio" name="summary-length" value="4 Sentences" checked /> 4 Sentences Summary</label>
    <label><input type="radio" name="summary-length" value="5 Sentences" /> 5 Sentences Summary</label>
    <label><input type="radio" name="summary-length" value="6 Sentences" /> 6 Sentences Summary</label>
  </div>

  <textarea id="assessment-text" placeholder="Assessment Summary Text"></textarea>

  <div class="btn-row">
    <button id="generate-assessment-btn">AI Generate Assessment Summary</button>
    <button id="copy-assessment-btn" type="button">Copy</button>
    <span id="assessment-status" class="status-text"></span>
  </div>
</fieldset>
{% endblock %}

{% block scripts %}
<script>
  // Helper to get checked values from group
  function getCheckedValues(name) {
    return Array.from(document.querySelectorAll('input[name="'+name+'"]:checked')).map(cb => cb.value);
  }

  // Helper to get trimmed text input value if not empty
  function getTextInputValue(name) {
    const el = document.querySelector(`input[name="${name}"]`);
    if (el && el.value.trim() !== "") {
      return el.value.trim();
    }
    return null;
  }

  // Copy text helper
  function copyText(id) {
    const textArea = document.getElementById(id);
    if (textArea.value.trim() === "") {
      alert("Nothing to copy!");
      return;
    }
    textArea.select();
    textArea.setSelectionRange(0, 99999); // For mobile devices
    navigator.clipboard.writeText(textArea.value)
      .then(() => alert("Copied to clipboard!"))
      .catch(() => alert("Failed to copy."));
  }

  // Subjective generate button
  document.getElementById('generate-subjective-btn').addEventListener('click', async () => {
    const subjectiveStatus = document.getElementById('subjective-status');
    // Collect checked checkboxes
    const subjectiveValues = getCheckedValues('therapist').concat(getCheckedValues('subjective'));

    // Collect "Other" text input values if present
    const sensationOther = getTextInputValue('subjective_sensation_other');
    const feelingOther = getTextInputValue('subjective_feeling_other');
    const activityOther = getTextInputValue('subjective_activity_other');

    if (sensationOther) subjectiveValues.push(`Sensation Other: ${sensationOther}`);
    if (feelingOther) subjectiveValues.push(`Feeling Other: ${feelingOther}`);
    if (activityOther) subjectiveValues.push(`Activity Limitations Other: ${activityOther}`);

    if (subjectiveValues.length === 0) {
      alert('Please select some subjective checkboxes or enter other information first.');
      return;
    }

    subjectiveStatus.textContent = "Generating...";
    try {
      const prompt = `Rewrite this patient's subjective information into a clear professional narrative suitable for clinical notes. Only Use Patient or pt to address and do not use The Patient.:\n\n${subjectiveValues.join(', ')}`;
      const response = await fetch('/api/generate-subjective', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt })
      });
      if (!response.ok) throw new Error("Server error");
      const data = await response.json();
      if (data.text) {
        document.getElementById('subjective-text').value = data.text;
        subjectiveStatus.textContent = "Done.";
      } else {
        subjectiveStatus.textContent = "";
        alert('Error generating subjective text.');
      }
    } catch (err) {
      subjectiveStatus.textContent = "";
      alert('Error generating subjective text.');
    }
  });

  // Subjective copy button
  document.getElementById('copy-subjective-btn').addEventListener('click', () => {
    copyText('subjective-text');
  });

  // Assessment generate button
  document.getElementById('generate-assessment-btn').addEventListener('click', async () => {
    const assessmentStatus = document.getElementById('assessment-status');
    const assessmentValues = getCheckedValues('assessment');
    const summaryLength = document.querySelector('input[name="summary-length"]:checked').value;
    if (assessmentValues.length === 0) {
      alert('Please select some assessment checkboxes first.');
      return;
    }
    assessmentStatus.textContent = "Generating...";
    try {
      const prompt = `Generate a Medicare-appropriate treatment session summary based on the following assessment information. The summary should be ${summaryLength} long:\n\n${assessmentValues.join(', ')}`;
      const response = await fetch('/api/generate-assessment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt })
      });
      if (!response.ok) throw new Error("Server error");
      const data = await response.json();
      if (data.text) {
        document.getElementById('assessment-text').value = data.text;
        assessmentStatus.textContent = "Done.";
      } else {
        assessmentStatus.textContent = "";
        alert('Error generating assessment summary.');
      }
    } catch (err) {
      assessmentStatus.textContent = "";
      alert('Error generating assessment summary.');
    }
  });

  // Assessment copy button
  document.getElementById('copy-assessment-btn').addEventListener('click', () => {
    copyText('assessment-text');
  });
</script>
{% endblock %}
