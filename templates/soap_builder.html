{% extends 'base.html' %}
{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SOAP Builder</title>
<style>
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
    max-width: 1100px;
    margin: auto;
    background: #f4f7fb;
  }
  h1, h2 {
    font-family: Calibri, sans-serif;
  }
  .section {
    background: white;
    padding: 20px;
    margin-bottom: 30px;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgb(0 0 0 / 0.1);
  }
  table {
    width: 100%;
    border-collapse: collapse;
  }
  td, th {
    padding: 8px 6px;
    vertical-align: top;
  }
  th {
    text-align: right;
    width: 180px;
    font-weight: 600;
    font-family: Calibri, sans-serif;
  }
  .checkbox-group label {
    margin-right: 15px;
    font-family: Calibri, sans-serif;
    font-size: 11pt;
    user-select: none;
  }
  textarea {
    width: 100%;
    height: 140px;
    margin-top: 10px;
    font-family: Calibri, monospace;
    font-size: 11pt;
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    resize: vertical;
  }
  .button-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
  }
  button {
    cursor: pointer;
    padding: 8px 18px;
    font-family: Calibri, sans-serif;
    font-size: 11pt;
    border-radius: 6px;
    border: none;
    background-color: #1969ff;
    color: white;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background-color: #0047d4;
  }
  .copy-button {
    background-color: #555;
  }
  .copy-button:hover {
    background-color: #333;
  }
  .status-text {
    font-family: Calibri, sans-serif;
    font-size: 11pt;
    font-style: italic;
    color: #555;
    min-width: 80px;
  }
</style>
</head>
<body>

<h1>SOAP Builder</h1>

<div class="section" id="subjective-section">
  <h2>Subjective</h2>
  <table>
    <tr>
      <th>Therapist:</th>
      <td class="checkbox-group">
        <label><input type="checkbox" name="therapist" value="PT" /> PT</label>
        <label><input type="checkbox" name="therapist" value="OT" /> OT</label>
      </td>
    </tr>
    <tr>
      <th>Pt States / Pt Reports:</th>
      <td class="checkbox-group">
        <label><input type="checkbox" name="subjective" value="Pt states" /> Pt states</label>
        <label><input type="checkbox" name="subjective" value="Pt reports" /> Pt reports</label>
      </td>
    </tr>
    <tr>
      <th>Sides:</th>
      <td class="checkbox-group">
        <label><input type="checkbox" name="subjective" value="right" /> right</label>
        <label><input type="checkbox" name="subjective" value="left" /> left</label>
      </td>
    </tr>
    <tr>
      <th>Location of Pain:</th>
      <td class="checkbox-group">
        <label><input type="checkbox" name="subjective" value="neck" /> neck</label>
        <label><input type="checkbox" name="subjective" value="shoulder" /> shoulder</label>
        <label><input type="checkbox" name="subjective" value="arm" /> arm</label>
        <label><input type="checkbox" name="subjective" value="elbow" /> elbow</label>
        <label><input type="checkbox" name="subjective" value="wrist" /> wrist</label>
        <label><input type="checkbox" name="subjective" value="hand" /> hand</label>
        <label><input type="checkbox" name="subjective" value="mid back" /> mid back</label>
        <label><input type="checkbox" name="subjective" value="low back" /> low back</label>
        <label><input type="checkbox" name="subjective" value="hip" /> hip</label>
        <label><input type="checkbox" name="subjective" value="thigh" /> thigh</label>
        <label><input type="checkbox" name="subjective" value="knee" /> knee</label>
        <label><input type="checkbox" name="subjective" value="calf" /> calf</label>
        <label><input type="checkbox" name="subjective" value="ankle" /> ankle</label>
        <label><input type="checkbox" name="subjective" value="foot" /> foot</label>
      </td>
    </tr>
    <tr>
      <th>Sensation:</th>
      <td class="checkbox-group">
        <label><input type="checkbox" name="subjective" value="pain" /> pain</label>
        <label><input type="checkbox" name="subjective" value="numbness" /> numbness</label>
        <label><input type="checkbox" name="subjective" value="ache" /> ache</label>
        <label><input type="checkbox" name="subjective" value="tightness" /> tightness</label>
        <input type="text" name="subjective_sensation_other" placeholder="Other sensation" style="font-family: Calibri; font-size: 11pt; margin-left:10px; width:200px;"/>
      </td>
    </tr>
    <tr>
      <th>Feeling Today:</th>
      <td class="checkbox-group">
        <label><input type="checkbox" name="subjective" value="no new changes" /> no new changes</label>
        <label><input type="checkbox" name="subjective" value="okay" /> okay</label>
        <label><input type="checkbox" name="subjective" value="generalized weakness" /> generalized weakness</label>
        <input type="text" name="subjective_feeling_other" placeholder="Other feeling" style="font-family: Calibri; font-size: 11pt; margin-left:10px; width:200px;"/>
      </td>
    </tr>
    <tr>
      <th>Functional Limitations:</th>
      <td class="checkbox-group">
        <label><input type="checkbox" name="subjective" value="sleeping" /> sleeping</label>
        <label><input type="checkbox" name="subjective" value="lying" /> lying</label>
        <label><input type="checkbox" name="subjective" value="sitting" /> sitting</label>
        <label><input type="checkbox" name="subjective" value="standing" /> standing</label>
        <label><input type="checkbox" name="subjective" value="walking" /> walking</label>
        <label><input type="checkbox" name="subjective" value="stairs/steps negotiation" /> stairs/steps negotiation</label>
        <label><input type="checkbox" name="subjective" value="bending" /> bending</label>
        <label><input type="checkbox" name="subjective" value="movement" /> movement</label>
      </td>
    </tr>
    <tr>
      <th>Activities Limitations:</th>
      <td class="checkbox-group">
        <label><input type="checkbox" name="subjective" value="cooking" /> cooking</label>
        <label><input type="checkbox" name="subjective" value="cleaning" /> cleaning</label>
        <label><input type="checkbox" name="subjective" value="grooming" /> grooming</label>
        <label><input type="checkbox" name="subjective" value="dressing" /> dressing</label>
        <label><input type="checkbox" name="subjective" value="gardening" /> gardening</label>
        <label><input type="checkbox" name="subjective" value="laundry" /> laundry</label>
        <label><input type="checkbox" name="subjective" value="sweeping" /> sweeping</label>
        <label><input type="checkbox" name="subjective" value="watching grand kids" /> watching grand kids</label>
        <input type="text" name="subjective_activity_other" placeholder="Other activity limitation" style="font-family: Calibri; font-size: 11pt; margin-left:10px; width:200px;"/>
      </td>
    </tr>
    <tr>
      <th>Pain:</th>
      <td class="checkbox-group">
        <label><input type="checkbox" name="subjective" value="pain: Yes" /> Yes</label>
        <label><input type="checkbox" name="subjective" value="pain: No" /> No</label>
      </td>
    </tr>
    <tr>
      <th>Tolerance:</th>
      <td class="checkbox-group">
        <label><input type="checkbox" name="subjective" value="tolerance: decrease" /> decrease</label>
        <label><input type="checkbox" name="subjective" value="tolerance: limited" /> limited</label>
        <label><input type="checkbox" name="subjective" value="tolerance: improved" /> improved</label>
        <label><input type="checkbox" name="subjective" value="symptom increased" /> symptom increased</label>
      </td>
    </tr>
    <tr>
      <th>Pt agrees to tx today:</th>
      <td class="checkbox-group">
        <label><input type="checkbox" name="subjective" value="Pt agrees to tx today" /> Yes</label>
      </td>
    </tr>
  </table>

  <textarea id="subjective-text" placeholder="Subjective Field: Final Text"></textarea>

  <div class="button-row">
    <button id="generate-subjective-btn">AI Regenerate Subjective</button>
    <span id="subjective-status" class="status-text"></span>
    <button class="copy-button" data-target="subjective-text">Copy</button>
  </div>
</div>

<div class="section" id="assessment-section">
  <h2>Assessment</h2>
  <table>
    <tr>
      <th>Assessment Category:</th>
      <td class="checkbox-group">
        <label><input type="checkbox" name="assessment" value="Tenderness with Palpation" /> Tenderness with Palpation</label>
        <label><input type="checkbox" name="assessment" value="Pain with functional movement" /> Pain with functional movement</label>
        <label><input type="checkbox" name="assessment" value="Pain with sitting" /> Pain with sitting</label>
        <label><input type="checkbox" name="assessment" value="Soft Tissue Restriction" /> Soft Tissue Restriction</label>
        <label><input type="checkbox" name="assessment" value="Myotension" /> Myotension</label>
      </td>
    </tr>
    <tr>
      <th>Treatment Intervention:</th>
      <td class="checkbox-group">
        <label><input type="checkbox" name="assessment" value="Manual Therapy" /> Manual Therapy</label>
        <label><input type="checkbox" name="assessment" value="Therapeutic Exercises" /> Therapeutic Exercises</label>
        <label><input type="checkbox" name="assessment" value="Therapeutic Activity" /> Therapeutic Activity</label>
        <label><input type="checkbox" name="assessment" value="Gait Training" /> Gait Training</label>
        <label><input type="checkbox" name="assessment" value="Neuromuscular Re-education" /> Neuromuscular Re-education</label>
        <label><input type="checkbox" name="assessment" value="Stretching" /> Stretching</label>
        <label><input type="checkbox" name="assessment" value="STM" /> STM</label>
        <label><input type="checkbox" name="assessment" value="Trigger Point Release" /> Trigger Point Release</label>
      </td>
    </tr>
    <tr>
      <th>Tolerance:</th>
      <td class="checkbox-group">
        <label><input type="checkbox" name="assessment" value="Good" /> Good</label>
        <label><input type="checkbox" name="assessment" value="Fair" /> Fair</label>
        <label><input type="checkbox" name="assessment" value="Poor" /> Poor</label>
      </td>
    </tr>
    <tr>
      <th>Training Cues:</th>
      <td class="checkbox-group">
        <label><input type="checkbox" name="assessment" value="Verbal Cue" /> Verbal Cue</label>
        <label><input type="checkbox" name="assessment" value="Tactile Cue" /> Tactile Cue</label>
        <label><input type="checkbox" name="assessment" value="Demonstration" /> Demonstration</label>
        <label><input type="checkbox" name="assessment" value="Education" /> Education</label>
      </td>
    </tr>
    <tr>
      <th>Outcome:</th>
      <td class="checkbox-group">
        <label><input type="checkbox" name="assessment" value="Acknowledge" /> Acknowledge</label>
        <label><input type="checkbox" name="assessment" value="Comprehend" /> Comprehend</label>
        <label><input type="checkbox" name="assessment" value="Decrease Symptoms" /> Decrease Symptoms</label>
        <label><input type="checkbox" name="assessment" value="Pain Reduction" /> Pain Reduction</label>
        <label><input type="checkbox" name="assessment" value="Decrease Tension" /> Decrease Tension</label>
        <label><input type="checkbox" name="assessment" value="Decrease Tissue Restriction" /> Decrease Tissue Restriction</label>
        <label><input type="checkbox" name="assessment" value="Improved movement tolerance" /> Improved movement tolerance</label>
        <label><input type="checkbox" name="assessment" value="Improve safety awareness" /> Improve safety awareness</label>
      </td>
    </tr>
    <tr>
      <th>Plan:</th>
      <td class="checkbox-group">
        <label><input type="checkbox" name="assessment" value="Continue with tx to meet goals" /> Continue with tx to meet goals</label>
        <label><input type="checkbox" name="assessment" value="Need further treatment" /> Need further treatment</label>
        <label><input type="checkbox" name="assessment" value="Will continue to benefit" /> Will continue to benefit</label>
        <label><input type="checkbox" name="assessment" value="Essential to further improve and return to PLOF" /> Essential to further improve and return to PLOF</label>
      </td>
    </tr>
    <tr>
      <th>Summary Length:</th>
      <td class="checkbox-group">
        <label><input type="checkbox" name="assessment_summary_length" value="4 Sentences Summary" /> 4 Sentences Summary</label>
        <label><input type="checkbox" name="assessment_summary_length" value="5 Sentences Summary" /> 5 Sentences Summary</label>
        <label><input type="checkbox" name="assessment_summary_length" value="6 Sentences Summary" /> 6 Sentences Summary</label>
        <label><input type="checkbox" name="assessment_summary_length" value="7 Sentences Summary" /> 7 Sentences Summary</label>
      </td>
    </tr>
  </table>

  <textarea id="assessment-text" placeholder="Assessment Field: Final Text"></textarea>

  <div class="button-row">
    <button id="generate-assessment-btn">AI Generate Assessment</button>
    <span id="assessment-status" class="status-text"></span>
    <button class="copy-button" data-target="assessment-text">Copy</button>
  </div>
</div>

<div class="section" id="plan-section">
  <h2>Plan of Care</h2>
  <table>
    <tr>
      <th>Next Visit Plan:</th>
      <td class="checkbox-group">
        <label><input type="checkbox" name="plan" value="Manual Therapy" /> Manual Therapy</label>
        <label><input type="checkbox" name="plan" value="MFR" /> MFR</label>
        <label><input type="checkbox" name="plan" value="STM" /> STM</label>
        <label><input type="checkbox" name="plan" value="TPR" /> TPR</label>
        <label><input type="checkbox" name="plan" value="Stretch" /> Stretch</label>
        <label><input type="checkbox" name="plan" value="Joint Mobilization" /> Joint Mobilization</label>
        <label><input type="checkbox" name="plan" value="Therapeutic Exercise Training" /> Therapeutic Exercise Training</label>
        <label><input type="checkbox" name="plan" value="Therapeutic Activity Training" /> Therapeutic Activity Training</label>
        <label><input type="checkbox" name="plan" value="Balance Training" /> Balance Training</label>
        <label><input type="checkbox" name="plan" value="Pain Management" /> Pain Management</label>
        <label><input type="checkbox" name="plan" value="Gait Training" /> Gait Training</label>
        <label><input type="checkbox" name="plan" value="Neuromuscular Training" /> Neuromuscular Training</label>
        <label><input type="checkbox" name="plan" value="Ice" /> Ice</label>
        <label><input type="checkbox" name="plan" value="Heat" /> Heat</label>
        <label><input type="checkbox" name="plan" value="E-Stim" /> E-Stim</label>
        <label><input type="checkbox" name="plan" value="LLPS" /> LLPS</label>
        <label><input type="checkbox" name="plan" value="Education" /> Education</label>
        <label><input type="checkbox" name="plan" value="HEP Review" /> HEP Review</label>
        <label><input type="checkbox" name="plan" value="Fall/Safety Training" /> Fall/Safety Training</label>
        <label><input type="checkbox" name="plan" value="Energy Conservation Training" /> Energy Conservation Training</label>
        <label><input type="checkbox" name="plan" value="Task/Dual Task Training" /> Task/Dual Task Training</label>
      </td>
    </tr>
    <tr>
      <th>Summary Length:</th>
      <td class="checkbox-group">
        <label><input type="checkbox" name="plan_summary_length" value="1 Sentence Summary" /> 1 Sentence Summary</label>
        <label><input type="checkbox" name="plan_summary_length" value="2 Sentences Summary" /> 2 Sentences Summary</label>
        <label><input type="checkbox" name="plan_summary_length" value="3 Sentences Summary" /> 3 Sentences Summary</label>
        <label><input type="checkbox" name="plan_summary_length" value="4 Sentences Summary" /> 4 Sentences Summary</label>
      </td>
    </tr>
  </table>

  <textarea id="plan-text" placeholder="Plan Field: Final Text"></textarea>

  <div class="button-row">
    <button id="generate-plan-btn">AI Generate Plan</button>
    <span id="plan-status" class="status-text"></span>
    <button class="copy-button" data-target="plan-text">Copy</button>
  </div>
</div>

<script>
  // Copy button functionality
  function copyToClipboard(textareaId) {
    const textarea = document.getElementById(textareaId);
    textarea.select();
    textarea.setSelectionRange(0, 99999);
    document.execCommand('copy');
    alert('Copied to clipboard');
  }
  document.querySelectorAll('.copy-button').forEach(btn => {
    btn.addEventListener('click', () => {
      copyToClipboard(btn.getAttribute('data-target'));
    });
  });

  // Helper to get checked values by name
  function getCheckedValues(name) {
    return Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(cb => cb.value);
  }

  // Helper to get trimmed text input value if present
  function getTextInputValue(name) {
    const el = document.querySelector(`input[name="${name}"]`);
    return el && el.value.trim() !== '' ? el.value.trim() : null;
  }

  // Generate Subjective
  document.getElementById('generate-subjective-btn').addEventListener('click', async () => {
    const status = document.getElementById('subjective-status');
    let values = getCheckedValues('therapist').concat(getCheckedValues('subjective'));

    const sensationOther = getTextInputValue('subjective_sensation_other');
    const feelingOther = getTextInputValue('subjective_feeling_other');
    const activityOther = getTextInputValue('subjective_activity_other');

    if (sensationOther) values.push(`Sensation Other: ${sensationOther}`);
    if (feelingOther) values.push(`Feeling Other: ${feelingOther}`);
    if (activityOther) values.push(`Activity Limitations Other: ${activityOther}`);

    if (values.length === 0) {
      alert('Please select some subjective checkboxes or enter other information first.');
      return;
    }
    status.textContent = 'Generating...';
    try {
      const prompt = `Rewrite this patient's subjective information into a clear professional narrative suitable for clinical notes:\n\n${values.join(' ')}`;
      const response = await fetch('/api/generate-subjective', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({prompt}),
      });
      const data = await response.json();
      if (data.text) {
        document.getElementById('subjective-text').value = data.text;
        status.textContent = 'Done.';
      } else {
        status.textContent = '';
        alert('Error generating subjective text.');
      }
    } catch {
      status.textContent = '';
      alert('Error generating subjective text.');
    }
  });

  // Generate Assessment
  document.getElementById('generate-assessment-btn').addEventListener('click', async () => {
    const status = document.getElementById('assessment-status');
    let values = getCheckedValues('assessment');

    const summaryLengths = getCheckedValues('assessment_summary_length');
    if (summaryLengths.length > 0) {
      values.push(`Summary Length: ${summaryLengths.join(' ')}`);
    }

    if (values.length === 0) {
      alert('Please select some assessment checkboxes or enter other information first.');
      return;
    }
    status.textContent = 'Generating...';
    try {
      const prompt = `Rewrite this assessment into a professional clinical note narrative:\n\n${values.join(' ')}`;
      const response = await fetch('/api/generate-assessment', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({prompt}),
      });
      const data = await response.json();
      if (data.text) {
        document.getElementById('assessment-text').value = data.text;
        status.textContent = 'Done.';
      } else {
        status.textContent = '';
        alert('Error generating assessment text.');
      }
    } catch {
      status.textContent = '';
      alert('Error generating assessment text.');
    }
  });

  // Generate Plan
  document.getElementById('generate-plan-btn').addEventListener('click', async () => {
    const status = document.getElementById('plan-status');
    let values = getCheckedValues('plan');

    const summaryLengths = getCheckedValues('plan_summary_length');
    if (summaryLengths.length > 0) {
      values.push(`Summary Length: ${summaryLengths.join(' ')}`);
    }

    if (values.length === 0) {
      alert('Please select some plan checkboxes or enter other information first.');
      return;
    }
    status.textContent = 'Generating...';
    try {
      const prompt = `Rewrite this plan of care into a clear professional narrative suitable for clinical notes:\n\n${values.join(' ')}`;
      const response = await fetch('/api/generate-plan', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({prompt}),
      });
      const data = await response.json();
      if (data.text) {
        document.getElementById('plan-text').value = data.text;
        status.textContent = 'Done.';
      } else {
        status.textContent = '';
        alert('Error generating plan text.');
      }
    } catch {
      status.textContent = '';
      alert('Error generating plan text.');
    }
  });
</script>

</body>
</html>

{% endblock %}
