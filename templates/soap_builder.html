{% extends "base.html" %}

{% block title %}SOAP Builder{% endblock %}

{% block head %}
<style>
  /* Keep styles scoped to SOAP Builder page */
  fieldset { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; }
  legend { font-weight: bold; }
  .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; }
  label { user-select: none; }
  textarea { width: 100%; height: 120px; margin-top: 10px; font-family: monospace; }
  button { margin-top: 10px; padding: 8px 15px; cursor: pointer; }
</style>
{% endblock %}

{% block content %}
<h1>SOAP Builder</h1>

<!-- Therapist Category -->
<fieldset>
  <legend>Therapist</legend>
  <div class="checkbox-group">
    <label><input type="checkbox" name="therapist" value="PT" /> PT</label>
    <label><input type="checkbox" name="therapist" value="OT" /> OT</label>
  </div>
</fieldset>

<!-- Subjective Category -->
<fieldset>
  <legend>Subjective</legend>

  <strong>Pt States / Pt Reports:</strong>
  <div class="checkbox-group">
    <label><input type="checkbox" name="subjective" value="Pt states" /> Pt states</label>
    <label><input type="checkbox" name="subjective" value="Pt reports" /> Pt reports</label>
  </div>

  <strong>Sides:</strong>
  <div class="checkbox-group">
    <label><input type="checkbox" name="subjective" value="right" /> right</label>
    <label><input type="checkbox" name="subjective" value="left" /> left</label>
  </div>

  <strong>Location of Pain:</strong>
  <div class="checkbox-group">
    <label><input type="checkbox" name="subjective" value="neck" /> neck</label>
    <label><input type="checkbox" name="subjective" value="shoulder" /> shoulder</label>
    <label><input type="checkbox" name="subjective" value="arm" /> arm</label>
    <label><input type="checkbox" name="subjective" value="elbow" /> elbow</label>
    <label><input type="checkbox" name="subjective" value="wrist" /> wrist</label>
    <label><input type="checkbox" name="subjective" value="hand" /> hand</label>
    <label><input type="checkbox" name="subjective" value="mid back" /> mid back</label>
    <label><input type="checkbox" name="subjective" value="low back" /> low back</label>
    <label><input type="checkbox" name="subjective" value="hip" /> hip</label>
    <label><input type="checkbox" name="subjective" value="thigh" /> thigh</label>
    <label><input type="checkbox" name="subjective" value="knee" /> knee</label>
    <label><input type="checkbox" name="subjective" value="calf" /> calf</label>
    <label><input type="checkbox" name="subjective" value="ankle" /> ankle</label>
    <label><input type="checkbox" name="subjective" value="foot" /> foot</label>
  </div>

  <strong>Sensation:</strong>
  <div class="checkbox-group">
    <label><input type="checkbox" name="subjective" value="pain" /> pain</label>
    <label><input type="checkbox" name="subjective" value="numbness" /> numbness</label>
    <label><input type="checkbox" name="subjective" value="ache" /> ache</label>
    <label><input type="checkbox" name="subjective" value="tightness" /> tightness</label>
  </div>

  <strong>Feeling Today:</strong>
  <div class="checkbox-group">
    <label><input type="checkbox" name="subjective" value="no new changes" /> no new changes</label>
    <label><input type="checkbox" name="subjective" value="okay" /> okay</label>
    <label><input type="checkbox" name="subjective" value="generalized weakness" /> generalized weakness</label>
  </div>

  <strong>Functional Limitations:</strong>
  <div class="checkbox-group">
    <label><input type="checkbox" name="subjective" value="sleeping" /> sleeping</label>
    <label><input type="checkbox" name="subjective" value="lying" /> lying</label>
    <label><input type="checkbox" name="subjective" value="sitting" /> sitting</label>
    <label><input type="checkbox" name="subjective" value="standing" /> standing</label>
    <label><input type="checkbox" name="subjective" value="walking" /> walking</label>
    <label><input type="checkbox" name="subjective" value="stairs/steps negotiation" /> stairs/steps negotiation</label>
    <label><input type="checkbox" name="subjective" value="bending" /> bending</label>
    <label><input type="checkbox" name="subjective" value="movement" /> movement</label>
  </div>

  <strong>Activities Limitations:</strong>
  <div class="checkbox-group">
    <label><input type="checkbox" name="subjective" value="cooking" /> cooking</label>
    <label><input type="checkbox" name="subjective" value="cleaning" /> cleaning</label>
    <label><input type="checkbox" name="subjective" value="grooming" /> grooming</label>
    <label><input type="checkbox" name="subjective" value="dressing" /> dressing</label>
    <label><input type="checkbox" name="subjective" value="gardening" /> gardening</label>
    <label><input type="checkbox" name="subjective" value="laundry" /> laundry</label>
    <label><input type="checkbox" name="subjective" value="sweeping" /> sweeping</label>
    <label><input type="checkbox" name="subjective" value="watching grand kids" /> watching grand kids</label>
  </div>

  <strong>Pain:</strong>
  <div class="checkbox-group">
    <label><input type="checkbox" name="subjective" value="pain: Yes" /> Yes</label>
    <label><input type="checkbox" name="subjective" value="pain: No" /> No</label>
  </div>

  <strong>Tolerance:</strong>
  <div class="checkbox-group">
    <label><input type="checkbox" name="subjective" value="tolerance: decrease" /> decrease</label>
    <label><input type="checkbox" name="subjective" value="tolerance: limited" /> limited</label>
    <label><input type="checkbox" name="subjective" value="tolerance: improved" /> improved</label>
    <label><input type="checkbox" name="subjective" value="symptom increased" /> symptom increased</label>
  </div>

  <div class="checkbox-group">
    <label><input type="checkbox" name="subjective" value="Pt agrees to tx today" /> Pt agrees to tx today</label>
  </div>

  <textarea id="subjective-text" placeholder="Subjective Field: Final Text"></textarea>
  <button id="generate-subjective-btn">AI Regenerate Subjective</button>
</fieldset>

<!-- Assessment Category -->
<fieldset>
  <legend>Assessment</legend>

  <strong>Assessment Categories:</strong>
  <div class="checkbox-group">
    <label><input type="checkbox" name="assessment" value="Tenderness with Palpation" /> Tenderness with Palpation</label>
    <label><input type="checkbox" name="assessment" value="pain with functional movement" /> pain with functional movement</label>
    <label><input type="checkbox" name="assessment" value="pain with sitting" /> pain with sitting</label>
    <label><input type="checkbox" name="assessment" value="Soft Tissue Restriction" /> Soft Tissue Restriction</label>
    <label><input type="checkbox" name="assessment" value="Myotension" /> Myotension</label>
  </div>

  <strong>Treatment Intervention:</strong>
  <div class="checkbox-group">
    <label><input type="checkbox" name="assessment" value="Manual Therapy" /> Manual Therapy</label>
    <label><input type="checkbox" name="assessment" value="Therapeutic Exercises" /> Therapeutic Exercises</label>
    <label><input type="checkbox" name="assessment" value="Therapeutic Activity" /> Therapeutic Activity</label>
    <label><input type="checkbox" name="assessment" value="Gait Training" /> Gait Training</label>
    <label><input type="checkbox" name="assessment" value="Neuromuscular Re-education" /> Neuromuscular Re-education</label>
    <label><input type="checkbox" name="assessment" value="Stretching" /> Stretching</label>
    <label><input type="checkbox" name="assessment" value="STM" /> STM</label>
    <label><input type="checkbox" name="assessment" value="Trigger Point Release" /> Trigger Point Release</label>
  </div>

  <strong>Tolerance:</strong>
  <div class="checkbox-group">
    <label><input type="checkbox" name="assessment" value="Good" /> Good</label>
    <label><input type="checkbox" name="assessment" value="Fair" /> Fair</label>
    <label><input type="checkbox" name="assessment" value="Poor" /> Poor</label>
  </div>

  <strong>Training Cues:</strong>
  <div class="checkbox-group">
    <label><input type="checkbox" name="assessment" value="Verbal Cue" /> Verbal Cue</label>
    <label><input type="checkbox" name="assessment" value="Tactile Cue" /> Tactile Cue</label>
    <label><input type="checkbox" name="assessment" value="Demonstration" /> Demonstration</label>
    <label><input type="checkbox" name="assessment" value="Education" /> Education</label>
  </div>

  <strong>Outcome:</strong>
  <div class="checkbox-group">
    <label><input type="checkbox" name="assessment" value="Acknowledge" /> Acknowledge</label>
    <label><input type="checkbox" name="assessment" value="Comprehend" /> Comprehend</label>
    <label><input type="checkbox" name="assessment" value="Decrease Symptoms" /> Decrease Symptoms</label>
    <label><input type="checkbox" name="assessment" value="Pain Reduction" /> Pain Reduction</label>
    <label><input type="checkbox" name="assessment" value="Decrease Tension" /> Decrease Tension</label>
    <label><input type="checkbox" name="assessment" value="Decrease Tissue Restriction" /> Decrease Tissue Restriction</label>
    <label><input type="checkbox" name="assessment" value="Improved movement tolerance" /> Improved movement tolerance</label>
    <label><input type="checkbox" name="assessment" value="improve safety awareness" /> improve safety awareness</label>
  </div>

  <strong>Plan:</strong>
  <div class="checkbox-group">
    <label><input type="checkbox" name="assessment" value="Continue with tx to meet goals" /> Continue with tx to meet goals</label>
    <label><input type="checkbox" name="assessment" value="Need further treatment" /> Need further treatment</label>
    <label><input type="checkbox" name="assessment" value="Will continue to benefit" /> Will continue to benefit</label>
    <label><input type="checkbox" name="assessment" value="Essential to further improve and return to PLOF" /> Essential to further improve and return to PLOF</label>
  </div>

  <strong>Summary Length:</strong>
  <div class="checkbox-group">
    <label><input type="radio" name="summary-length" value="4 Sentences" checked /> 4 Sentences Summary</label>
    <label><input type="radio" name="summary-length" value="5 Sentences" /> 5 Sentences Summary</label>
    <label><input type="radio" name="summary-length" value="6 Sentences" /> 6 Sentences Summary</label>
  </div>

  <textarea id="assessment-text" placeholder="Assessment Summary Text"></textarea>
  <button id="generate-assessment-btn">AI Generate Assessment Summary</button>
</fieldset>
{% endblock %}

{% block scripts %}
<script>
  // Helper to get checked values from group
  function getCheckedValues(name) {
    return Array.from(document.querySelectorAll('input[name="'+name+'"]:checked')).map(cb => cb.value);
  }

  // On clicking generate subjective button
  document.getElementById('generate-subjective-btn').addEventListener('click', async () => {
    const subjectiveValues = getCheckedValues('therapist').concat(getCheckedValues('subjective'));
    if (subjectiveValues.length === 0) {
      alert('Please select some subjective checkboxes first.');
      return;
    }

    const prompt = `Rewrite this patient's subjective information into a clear professional narrative suitable for clinical notes:\n\n${subjectiveValues.join(', ')}`;

    // Call your backend OpenAI route (to be implemented)
    const response = await fetch('/api/generate-subjective', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt })
    });

    if (response.ok) {
      const data = await response.json();
      document.getElementById('subjective-text').value = data.text;
    } else {
      alert('Error generating subjective text.');
    }
  });

  // On clicking generate assessment button
  document.getElementById('generate-assessment-btn').addEventListener('click', async () => {
    const assessmentValues = getCheckedValues('assessment');
    const summaryLength = document.querySelector('input[name="summary-length"]:checked').value;

    if (assessmentValues.length === 0) {
      alert('Please select some assessment checkboxes first.');
      return;
    }

    const prompt = `Generate a Medicare-appropriate treatment session summary based on the following assessment information. The summary should be ${summaryLength} long:\n\n${assessmentValues.join(', ')}`;

    // Call your backend OpenAI route (to be implemented)
    const response = await fetch('/api/generate-assessment', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt })
    });

    if (response.ok) {
      const data = await response.json();
      document.getElementById('assessment-text').value = data.text;
    } else {
      alert('Error generating assessment summary.');
    }
  });
</script>
{% endblock %}
