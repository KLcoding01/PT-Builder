{% extends 'base.html' %}
{% block content %}
<div class="container-fluid">
  <hr>
  <ul class="nav nav-tabs mb-3" id="mainTab" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" id="pt-tab-link" data-bs-toggle="tab" href="#pt-tab-panel" role="tab">PT Eval Builder</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="ot-tab-link" data-bs-toggle="tab" href="#ot-tab-panel" role="tab">OT Eval Builder</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="pt-soap-tab-link" data-bs-toggle="tab" href="#pt-soap-tab-panel" role="tab">PT SOAP - Daily Note</a>
    </li>
  </ul>
  <div class="tab-content" id="mainTabContent">
    <!-- PT EVAL BUILDER TAB -->
    <div class="tab-pane fade show active" id="pt-tab-panel" role="tabpanel">
      <h2>PT Eval Builder</h2>
      <div class="d-flex align-items-center mb-3">
        <label class="fw-bold me-2">Template:</label>
        <select id="pt-template-select" class="form-select w-auto me-2"></select>
        <button id="pt-load-template-btn" class="btn btn-outline-primary btn-sm">Load</button>
        <button id="pt-save-word-btn" class="btn btn-info btn-sm">Export Word</button>
        <button id="pt-save-pdf-btn" class="btn btn-danger btn-sm">Export PDF</button>
        <span id="pt-status-msg" class="ms-3"></span>
      </div>
      <ul class="nav nav-tabs mb-2" id="pt-inner-tab" role="tablist">
        <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#pt-patientinfo" role="tab">Patient Info</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#pt-history" role="tab">History</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#pt-pain" role="tab">Pain</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#pt-objective" role="tab">Objective</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#pt-diffdx" role="tab">Diff Dx</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#pt-summary" role="tab">Assessment Summary</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#pt-plan" role="tab">Plan</a></li>
      </ul>
      <form id="pt-evalform">
        <div class="tab-content">
          <!-- PATIENT INFO TAB -->
          <div class="tab-pane fade show active" id="pt-patientinfo" role="tabpanel">
            
            <div class="d-flex align-items-center mb-3">
              <label for="pt_patient_name" class="me-3 mb-0" style="min-width: 130px;"><strong>Patient Name:</strong></label>
              <input type="text" class="form-control" name="patient_name" id="pt_patient_name">
            </div>
            <div class="d-flex align-items-center mb-3">
              <label for="weight" class="me-2 mb-0" style="min-width: 100px;"><strong>Weight (lbs):</strong></label>
              <input type="number" class="form-control me-4" id="weight" name="weight" placeholder="lbs" style="max-width: 100px;">

              <label for="height" class="me-2 mb-0" style="min-width: 100px;"><strong>Height (in):</strong></label>
              <input type="number" class="form-control me-4" id="height" name="height" placeholder="in" style="max-width: 100px;">

              <label for="bmi" class="me-2 mb-0" style="min-width: 50px;"><strong>BMI:</strong></label>
              <input type="text" class="form-control me-4" id="bmi" name="bmi" readonly style="max-width: 80px;">

              <label for="bmi_category" class="me-2 mb-0" style="min-width: 120px;"><strong>BMI Category:</strong></label>
              <input type="text" class="form-control" id="bmi_category" name="bmi_category" readonly style="max-width: 150px;">
            </div>
            <div class="d-flex align-items-center mb-3">
              <label for="pt_dob" class="me-3 mb-0" style="min-width: 130px;"><strong>DOB:</strong></label>
              <input type="text" class="form-control" name="dob" id="pt_dob" placeholder="mm/dd/yyyy">
            </div>
            
            <div class="d-flex align-items-center mb-3">
              <label for="eval_date" class="me-3 mb-0" style="min-width: 130px;"><strong>Date of Eval:</strong></label>
              <input type="date" class="form-control" name="eval_date" id="eval_date">
            </div>
          </div>
          <!-- HISTORY TAB -->
          <div class="tab-pane fade" id="pt-history" role="tabpanel">
            <textarea name="meddiag" id="pt_meddiag" class="form-control mb-2" placeholder="Medical Diagnosis"></textarea>
            <textarea name="history" id="pt_history" class="form-control mb-2" placeholder="Medical History/HNP"></textarea>
            <textarea name="subjective" id="pt_subjective" class="form-control mb-2" placeholder="Subjective (HPI)"></textarea>
            <textarea name="meds" id="pt_meds" class="form-control mb-2" placeholder="Current Medication(s)"></textarea>
            <textarea name="tests" id="pt_tests" class="form-control mb-2" placeholder="Diagnostic Test(s)"></textarea>
            <textarea name="dme" id="pt_dme" class="form-control mb-2" placeholder="DME/Assistive Device"></textarea>
            <textarea name="plof" id="pt_plof" class="form-control mb-2" placeholder="PLOF"></textarea>
          </div>
          <!-- PAIN TAB -->
          <div class="tab-pane fade" id="pt-pain" role="tabpanel">
            <input name="pain_location" id="pt_pain_location" class="form-control mb-2" placeholder="Area/Location of Injury">
            <input name="pain_onset" id="pt_pain_onset" class="form-control mb-2" placeholder="Onset/Exacerbation Date">
            <input name="pain_condition" id="pt_pain_condition" class="form-control mb-2" placeholder="Condition of Injury">
            <input name="pain_mechanism" id="pt_pain_mechanism" class="form-control mb-2" placeholder="Mechanism of Injury">
            <input name="pain_rating" id="pt_pain_rating" class="form-control mb-2" placeholder="Pain Rating (P/B/W)">
            <input name="pain_frequency" id="pt_pain_frequency" class="form-control mb-2" placeholder="Pain Frequency">
            <input name="pain_description" id="pt_pain_description" class="form-control mb-2" placeholder="Description">
            <input name="pain_aggravating" id="pt_pain_aggravating" class="form-control mb-2" placeholder="Aggravating Factor">
            <input name="pain_relieved" id="pt_pain_relieved" class="form-control mb-2" placeholder="Relieved By">
            <input name="pain_interferes" id="pt_pain_interferes" class="form-control mb-2" placeholder="Interferes With">
          </div>
          <!-- OBJECTIVE TAB -->
          <div class="tab-pane fade" id="pt-objective" role="tabpanel">
            <textarea name="posture" id="pt_posture" class="form-control mb-2" rows="7" placeholder="Posture"></textarea>
            <textarea name="rom" id="pt_rom" class="form-control mb-2" rows="7" placeholder="ROM"></textarea>
            <textarea name="strength" id="pt_strength" class="form-control mb-2" rows="7" placeholder="Muscle Strength Test"></textarea>
            <textarea name="palpation" id="pt_palpation" class="form-control mb-2" rows="7" placeholder="Palpation"></textarea>
            <textarea name="functional" id="pt_functional" class="form-control mb-2" rows="7" placeholder="Functional Test(s)"></textarea>
            <textarea name="special" id="pt_special" class="form-control mb-2" rows="7" placeholder="Special Test(s)"></textarea>
            <textarea name="impairments" id="pt_impairments" class="form-control mb-2" rows="7" placeholder="Current Functional Mobility Impairment(s)"></textarea>
          </div>
          <!-- DIFF DX TAB -->
          <div class="tab-pane fade" id="pt-diffdx" role="tabpanel">
            <button type="button" id="pt-ai-generate-diffdx" class="btn btn-outline-success btn-sm mb-2">AI Generate</button>
            <textarea name="diffdx" id="pt_diffdx" class="form-control" rows="8"></textarea>
          </div>
          <!-- ASSESSMENT SUMMARY TAB -->
          <div class="tab-pane fade" id="pt-summary" role="tabpanel">
            <button type="button" id="pt-ai-generate-summary" class="btn btn-outline-success btn-sm mb-2">AI Generate</button>
            <textarea name="summary" id="pt_summary" class="form-control" rows="10"></textarea>
          </div>
          <!-- PLAN TAB -->
          <div class="tab-pane fade" id="pt-plan" role="tabpanel">
            <button type="button" id="pt-ai-generate-goals" class="btn btn-outline-success btn-sm mb-2">AI Generate Goals</button>
            <textarea name="goals" id="pt_goals" class="form-control mb-2" rows="10"></textarea>
            <input name="frequency" id="pt_frequency" class="form-control mb-2" placeholder="Frequency/Duration">
            <textarea name="intervention" id="pt_intervention" class="form-control mb-2" placeholder="Intervention"></textarea>
            <textarea name="procedures" id="pt_procedures" class="form-control mb-2" placeholder="Treatment Procedures"></textarea>
          </div>
        </div>
      </form>
    </div>
    <!-- OT EVAL BUILDER TAB -->
    <div class="tab-pane fade" id="ot-tab-panel" role="tabpanel">
      <h2>OT Eval Builder</h2>
      <div class="d-flex align-items-center mb-3">
        <label class="fw-bold me-2">Template:</label>
        <select id="ot-template-select" class="form-select w-auto me-2"></select>
        <button id="ot-load-template-btn" class="btn btn-outline-primary btn-sm">Load</button>
        <button id="ot-save-word-btn" class="btn btn-info btn-sm">Export Word</button>
        <button id="ot-save-pdf-btn" class="btn btn-danger btn-sm">Export PDF</button>
        <span id="ot-status-msg" class="ms-3"></span>
      </div>
      <ul class="nav nav-tabs mb-2" id="ot-inner-tab" role="tablist">
        <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#ot-patientinfo" role="tab">Patient Info</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#ot-history" role="tab">History</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#ot-pain" role="tab">Pain</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#ot-objective" role="tab">Objective</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#ot-diffdx" role="tab">Diff Dx</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#ot-summary" role="tab">Assessment Summary</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#ot-plan" role="tab">Plan</a></li>
      </ul>
      <form id="ot-evalform">
        <div class="tab-content">
          <!-- PATIENT INFO TAB -->
          <div class="tab-pane fade show active" id="ot-patientinfo" role="tabpanel">
            <div class="mb-2">
              <label class="form-label fw-bold">Patient Name:</label>
              <input type="text" class="form-control" name="patient_name" id="ot_patient_name">
            </div>
            <div class="mb-2">
              <label class="form-label fw-bold">DOB:</label>
              <input type="date" class="form-control" name="dob" id="ot_dob">
            </div>
            <div class="mb-2">
              <label class="form-label fw-bold">Date of Eval:</label>
              <input type="date" class="form-control" name="eval_date" id="ot_eval_date">
            </div>
          </div>
          <!-- HISTORY TAB -->
          <div class="tab-pane fade" id="ot-history" role="tabpanel">
            <textarea name="meddiag" id="ot_meddiag" class="form-control mb-2" placeholder="Medical Diagnosis"></textarea>
            <textarea name="history" id="ot_history" class="form-control mb-2" placeholder="Medical History/HNP"></textarea>
            <textarea name="subjective" id="ot_subjective" class="form-control mb-2" placeholder="Subjective (HPI)"></textarea>
            <textarea name="meds" id="ot_meds" class="form-control mb-2" placeholder="Current Medication(s)"></textarea>
            <textarea name="tests" id="ot_tests" class="form-control mb-2" placeholder="Diagnostic Test(s)"></textarea>
            <textarea name="dme" id="ot_dme" class="form-control mb-2" placeholder="DME/Assistive Device"></textarea>
            <textarea name="plof" id="ot_plof" class="form-control mb-2" placeholder="PLOF"></textarea>
          </div>
          <!-- PAIN TAB -->
          <div class="tab-pane fade" id="ot-pain" role="tabpanel">
            <input name="pain_location" id="ot_pain_location" class="form-control mb-2" placeholder="Area/Location of Injury">
            <input name="pain_onset" id="ot_pain_onset" class="form-control mb-2" placeholder="Onset/Exacerbation Date">
            <input name="pain_condition" id="ot_pain_condition" class="form-control mb-2" placeholder="Condition of Injury">
            <input name="pain_mechanism" id="ot_pain_mechanism" class="form-control mb-2" placeholder="Mechanism of Injury">
            <input name="pain_rating" id="ot_pain_rating" class="form-control mb-2" placeholder="Pain Rating (P/B/W)">
            <input name="pain_frequency" id="ot_pain_frequency" class="form-control mb-2" placeholder="Pain Frequency">
            <input name="pain_description" id="ot_pain_description" class="form-control mb-2" placeholder="Description">
            <input name="pain_aggravating" id="ot_pain_aggravating" class="form-control mb-2" placeholder="Aggravating Factor">
            <input name="pain_relieved" id="ot_pain_relieved" class="form-control mb-2" placeholder="Relieved By">
            <input name="pain_interferes" id="ot_pain_interferes" class="form-control mb-2" placeholder="Interferes With">
          </div>
          <!-- OBJECTIVE TAB -->
          <div class="tab-pane fade" id="ot-objective" role="tabpanel">
            <textarea name="posture" id="ot_posture" class="form-control mb-2" rows="7" placeholder="Posture"></textarea>
            <textarea name="rom" id="ot_rom" class="form-control mb-2" rows="7" placeholder="ROM"></textarea>
            <textarea name="strength" id="ot_strength" class="form-control mb-2" rows="7" placeholder="Muscle Strength Test"></textarea>
            <textarea name="palpation" id="ot_palpation" class="form-control mb-2" rows="7" placeholder="Palpation"></textarea>
            <textarea name="functional" id="ot_functional" class="form-control mb-2" rows="7" placeholder="Functional Test(s)"></textarea>
            <textarea name="special" id="ot_special" class="form-control mb-2" rows="7" placeholder="Special Test(s)"></textarea>
            <textarea name="impairments" id="ot_impairments" class="form-control mb-2" rows="7" placeholder="Current Functional Mobility Impairment(s)"></textarea>
          </div>
          <!-- DIFF DX TAB -->
          <div class="tab-pane fade" id="ot-diffdx" role="tabpanel">
            <button type="button" id="ot-ai-generate-diffdx" class="btn btn-outline-success btn-sm mb-2">AI Generate</button>
            <textarea name="diffdx" id="ot_diffdx" class="form-control" rows="8"></textarea>
          </div>
          <!-- ASSESSMENT SUMMARY TAB -->
          <div class="tab-pane fade" id="ot-summary" role="tabpanel">
            <button type="button" id="ot-ai-generate-summary" class="btn btn-outline-success btn-sm mb-2">AI Generate</button>
            <textarea name="summary" id="ot_summary" class="form-control" rows="10"></textarea>
          </div>
          <!-- PLAN TAB -->
          <div class="tab-pane fade" id="ot-plan" role="tabpanel">
            <button type="button" id="ot-ai-generate-goals" class="btn btn-outline-success btn-sm mb-2">AI Generate Goals</button>
            <textarea name="goals" id="ot_goals" class="form-control mb-2" rows="10"></textarea>
            <input name="frequency" id="ot_frequency" class="form-control mb-2" placeholder="Frequency/Duration">
            <textarea name="intervention" id="ot_intervention" class="form-control mb-2" placeholder="Intervention"></textarea>
            <textarea name="procedures" id="ot_procedures" class="form-control mb-2" placeholder="Treatment Procedures"></textarea>
          </div>
        </div>
      </form>
    </div>
    <!-- PT SOAP TAB (YOUR ORIGINAL CODE CAN GO HERE) -->
  </div>
<script>
  // ===== PT Functions =====
  function ptGetFields() {
    const data = {};
    document.querySelectorAll('#pt-evalform [name]').forEach(el => data[el.name] = el.value);
    return data;
  }
  function ptSetStatus(msg, color='green') {
    const s = document.getElementById('pt-status-msg');
    s.textContent = msg;
    s.style.color = color;
  }
  fetch('/pt_load_template', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({template: ''})
  })
    .then(r => r.json())
    .then(names => {
      document.getElementById('pt-template-select').innerHTML =
        names.map(n => `<option>${n}</option>`).join('');
    });
  document.getElementById('pt-load-template-btn').onclick = () => {
    fetch('/pt_load_template', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({template: document.getElementById('pt-template-select').value})
    })
      .then(r => r.json())
      .then(data => {
        Object.entries(data).forEach(([k,v]) => {
          const fld = document.getElementById('pt_'+k) || document.querySelector(`#pt-evalform [name="${k}"]`);
          if (fld) fld.value = v;
        });
      });
  };
  document.getElementById('pt-ai-generate-diffdx').onclick = () => {
    ptSetStatus('Generating Diff Dx…', 'orange');
    fetch('/pt_generate_diffdx', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({fields: ptGetFields()})
    })
    .then(r => r.json())
    .then(data => {
      if (data.result) {
        document.getElementById('pt_diffdx').value = data.result;
        ptSetStatus('Done','green');
      } else if (data.error) {
        ptSetStatus('AI error: ' + data.error, 'red');
      } else {
        ptSetStatus('Unexpected AI response', 'red');
      }
    })
    .catch(() => ptSetStatus('AI error','red'));
  };
  document.getElementById('pt-ai-generate-summary').onclick = () => {
    ptSetStatus('Generating summary…', 'orange');
    fetch('/pt_generate_summary', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({fields: ptGetFields()})
    })
    .then(r => r.json())
    .then(data => {
      if (data.result) {
        document.getElementById('pt_summary').value = data.result;
        ptSetStatus('Done','green');
      } else if (data.error) {
        ptSetStatus('AI error: ' + data.error, 'red');
      } else {
        ptSetStatus('Unexpected AI response', 'red');
      }
    })
    .catch(() => ptSetStatus('AI error','red'));
  };
  document.getElementById('pt-ai-generate-goals').onclick = () => {
    ptSetStatus('Generating goals…', 'orange');
    fetch('/pt_generate_goals', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({fields: ptGetFields()})
    })
    .then(response => response.json())
    .then(data => {
      if (data.result) {
        document.getElementById('pt_goals').value = data.result;
        ptSetStatus('Done', 'green');
      } else if (data.error) {
        ptSetStatus('AI error: ' + data.error, 'red');
      } else {
        ptSetStatus('Unexpected AI response', 'red');
      }
    })
    .catch(() => ptSetStatus('AI error', 'red'));
  };
  document.getElementById('pt-save-word-btn').onclick = () => {
    ptSetStatus('Exporting Word...', 'orange');
    fetch('/pt_export_word', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(ptGetFields())
    })
      .then(r => r.blob())
      .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'PT_Eval.docx';
        document.body.appendChild(a);
        a.click();
        a.remove();
        ptSetStatus('Word downloaded!', 'green');
      })
      .catch(() => ptSetStatus('Error exporting Word!', 'red'));
  };
  document.getElementById('pt-save-pdf-btn').onclick = () => {
    ptSetStatus('Exporting PDF...', 'orange');
    fetch('/pt_export_pdf', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(ptGetFields())
    })
      .then(r => r.blob())
      .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'PT_Eval.pdf';
        document.body.appendChild(a);
        a.click();
        a.remove();
        ptSetStatus('PDF downloaded!', 'green');
      })
      .catch(() => ptSetStatus('Error exporting PDF!', 'red'));
  };

  // ===== OT Functions =====
  function otGetFields() {
    const data = {};
    document.querySelectorAll('#ot-evalform [name]').forEach(el => data[el.name] = el.value);
    return data;
  }
  function otSetStatus(msg, color='green') {
    const s = document.getElementById('ot-status-msg');
    s.textContent = msg;
    s.style.color = color;
  }
  fetch('/ot_load_template', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({template: ''})
  })
    .then(r => r.json())
    .then(names => {
      document.getElementById('ot-template-select').innerHTML =
        names.map(n => `<option>${n}</option>`).join('');
    });
  document.getElementById('ot-load-template-btn').onclick = () => {
    fetch('/ot_load_template', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({template: document.getElementById('ot-template-select').value})
    })
      .then(r => r.json())
      .then(data => {
        Object.entries(data).forEach(([k,v]) => {
          const fld = document.getElementById('ot_'+k) || document.querySelector(`#ot-evalform [name="${k}"]`);
          if (fld) fld.value = v;
        });
      });
  };
  document.getElementById('ot-ai-generate-diffdx').onclick = () => {
    otSetStatus('Generating Diff Dx…', 'orange');
    fetch('/ot_generate_diffdx', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({fields: otGetFields()})
    })
    .then(r => r.json())
    .then(data => {
      if (data.result) {
        document.getElementById('ot_diffdx').value = data.result;
        otSetStatus('Done','green');
      } else if (data.error) {
        otSetStatus('AI error: ' + data.error, 'red');
      } else {
        otSetStatus('Unexpected AI response', 'red');
      }
    })
    .catch(() => otSetStatus('AI error','red'));
  };
  document.getElementById('ot-ai-generate-summary').onclick = () => {
    otSetStatus('Generating summary…', 'orange');
    fetch('/ot_generate_summary', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({fields: otGetFields()})
    })
    .then(r => r.json())
    .then(data => {
      if (data.result) {
        document.getElementById('ot_summary').value = data.result;
        otSetStatus('Done','green');
      } else if (data.error) {
        otSetStatus('AI error: ' + data.error, 'red');
      } else {
        otSetStatus('Unexpected AI response', 'red');
      }
    })
    .catch(() => otSetStatus('AI error','red'));
  };
  document.getElementById('ot-ai-generate-goals').onclick = () => {
    otSetStatus('Generating goals…', 'orange');
    fetch('/ot_generate_goals', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({fields: otGetFields()})
    })
    .then(response => response.json())
    .then(data => {
      if (data.result) {
        document.getElementById('ot_goals').value = data.result;
        otSetStatus('Done', 'green');
      } else if (data.error) {
        otSetStatus('AI error: ' + data.error, 'red');
      } else {
        otSetStatus('Unexpected AI response', 'red');
      }
    })
    .catch(() => otSetStatus('AI error', 'red'));
  };
  document.getElementById('ot-save-word-btn').onclick = () => {
    otSetStatus('Exporting Word...', 'orange');
    fetch('/ot_export_word', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(otGetFields())
    })
      .then(r => r.blob())
      .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'OT_Eval.docx';
        document.body.appendChild(a);
        a.click();
        a.remove();
        otSetStatus('Word downloaded!', 'green');
      })
      .catch(() => otSetStatus('Error exporting Word!', 'red'));
  };
  document.getElementById('ot-save-pdf-btn').onclick = () => {
    otSetStatus('Exporting PDF...', 'orange');
    fetch('/ot_export_pdf', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(otGetFields())
    })
      .then(r => r.blob())
      .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'OT_Eval.pdf';
        document.body.appendChild(a);
        a.click();
        a.remove();
        otSetStatus('PDF downloaded!', 'green');
      })
      .catch(() => otSetStatus('Error exporting PDF!', 'red'));
  };
</script>

<script>

// ===== BMI =====
  function calculateBMI() {
    const weight = parseFloat(document.getElementById("weight").value);
    const heightIn = parseFloat(document.getElementById("height").value);
    const bmiField = document.getElementById("bmi");
    const categoryField = document.getElementById("bmi_category");

    if (!isNaN(weight) && !isNaN(heightIn) && heightIn > 0) {
      const bmi = (weight / (heightIn * heightIn)) * 703;
      const roundedBMI = bmi.toFixed(1);
      bmiField.value = roundedBMI;

      let category = '';
      if (bmi < 18.5) category = "Underweight";
      else if (bmi < 24.9) category = "Normal";
      else if (bmi < 29.9) category = "Overweight";
      else category = "Obese";

      categoryField.value = category;
    } else {
      bmiField.value = '';
      categoryField.value = '';
    }
  }

  document.getElementById("weight").addEventListener("input", calculateBMI);
  document.getElementById("height").addEventListener("input", calculateBMI);
</script>

{% endblock %}
