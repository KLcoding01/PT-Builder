{% extends 'base.html' %}
{% block content %}
<div class="container-fluid">
  <hr>
  <!-- MAIN PT/OT SELECTOR -->
  <ul class="nav nav-tabs mb-3" id="mainTab" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" id="pt-tab-link" data-bs-toggle="tab" href="#pt-tab-panel" role="tab">PT Eval Builder</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="ot-tab-link" data-bs-toggle="tab" href="#ot-tab-panel" role="tab">OT Eval Builder</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="pt-soap-tab-link" data-bs-toggle="tab" href="#pt-soap-tab-panel" role="tab">PT SOAP - Daily Note</a>
    </li>
  </ul>

  <div class="tab-content" id="mainTabContent">
    <!-- PT EVAL BUILDER TAB -->
    <div class="tab-pane fade show active" id="pt-tab-panel" role="tabpanel">
      <h2>PT Eval Builder</h2>
      <div class="d-flex align-items-center mb-3">
        <label class="fw-bold me-2">Template:</label>
        <select id="pt-template-select" class="form-select w-auto me-2"></select>
        <button id="pt-load-template-btn" class="btn btn-outline-primary btn-sm">Load</button>
        <button id="pt-save-word-btn" class="btn btn-info btn-sm">Export Word</button>
        <button id="pt-save-pdf-btn" class="btn btn-danger btn-sm">Export PDF</button>
        <span id="pt-status-msg" class="ms-3"></span>
      </div>
      <ul class="nav nav-tabs mb-2" id="pt-inner-tab" role="tablist">
        <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#pt-patientinfo" role="tab">Patient Info</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#pt-history" role="tab">History</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#pt-pain" role="tab">Pain</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#pt-objective" role="tab">Objective</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#pt-diffdx" role="tab">Diff Dx</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#pt-summary" role="tab">Assessment Summary</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#pt-plan" role="tab">Plan</a></li>
      </ul>
      <form id="pt-evalform">
        <div class="tab-content">
          <!-- PATIENT INFO TAB -->
          <div class="tab-pane fade show active" id="pt-patientinfo" role="tabpanel">
            <div class="mb-2"><label class="form-label fw-bold">Patient Name:</label>
              <input type="text" class="form-control" name="patient_name" id="pt_patient_name"></div>
            <div class="mb-2"><label class="form-label fw-bold">DOB:</label>
              <input type="date" class="form-control" name="dob" id="pt_dob"></div>
            <div class="mb-2"><label class="form-label fw-bold">MRN:</label>
              <input type="text" class="form-control" name="mrn" id="pt_mrn"></div>
            <div class="mb-2"><label class="form-label fw-bold">Referring MD:</label>
              <input type="text" class="form-control" name="ref_md" id="pt_ref_md"></div>
            <div class="mb-2"><label class="form-label fw-bold">Date of Eval:</label>
              <input type="date" class="form-control" name="eval_date" id="pt_eval_date"></div>
            <div class="mb-2"><label class="form-label fw-bold">Therapist:</label>
              <input type="text" class="form-control" name="therapist" id="pt_therapist"></div>
            <div class="mb-2"><label class="form-label fw-bold">Visit Type:</label>
              <select class="form-select" name="visit_type" id="pt_visit_type">
                <option>Evaluation</option>
                <option>Re-Evaluation</option>
                <option>Discharge</option>
                <option>Other</option>
              </select>
            </div>
          </div>
          <!-- HISTORY TAB -->
          <div class="tab-pane fade" id="pt-history" role="tabpanel">
            <div class="mb-2"><label class="form-label fw-bold">Medical/Surgical History:</label>
              <textarea class="form-control" name="history" id="pt_history"></textarea></div>
            <div class="mb-2"><label class="form-label fw-bold">Social History:</label>
              <textarea class="form-control" name="social_history" id="pt_social_history"></textarea></div>
            <div class="mb-2"><label class="form-label fw-bold">Work/School History:</label>
              <textarea class="form-control" name="work_history" id="pt_work_history"></textarea></div>
            <div class="mb-2"><label class="form-label fw-bold">Living Situation:</label>
              <input type="text" class="form-control" name="living_situation" id="pt_living_situation"></div>
            <div class="mb-2"><label class="form-label fw-bold">Prior Level of Function:</label>
              <input type="text" class="form-control" name="prior_function" id="pt_prior_function"></div>
            <div class="mb-2"><label class="form-label fw-bold">Precautions:</label>
              <input type="text" class="form-control" name="precautions" id="pt_precautions"></div>
          </div>
          <!-- PAIN TAB -->
          <div class="tab-pane fade" id="pt-pain" role="tabpanel">
            <div class="mb-2"><label class="form-label fw-bold">Pain Location(s):</label>
              <input type="text" class="form-control" name="pain_location" id="pt_pain_location"></div>
            <div class="mb-2"><label class="form-label fw-bold">Pain Intensity (0-10):</label>
              <input type="number" min="0" max="10" class="form-control" name="pain_intensity" id="pt_pain_intensity"></div>
            <div class="mb-2"><label class="form-label fw-bold">Pain Quality/Description:</label>
              <input type="text" class="form-control" name="pain_description" id="pt_pain_description"></div>
            <div class="mb-2"><label class="form-label fw-bold">Aggravating Factors:</label>
              <input type="text" class="form-control" name="aggravating" id="pt_aggravating"></div>
            <div class="mb-2"><label class="form-label fw-bold">Alleviating Factors:</label>
              <input type="text" class="form-control" name="alleviating" id="pt_alleviating"></div>
            <div class="mb-2"><label class="form-label fw-bold">Pain Duration/Frequency:</label>
              <input type="text" class="form-control" name="pain_duration" id="pt_pain_duration"></div>
          </div>
          <!-- OBJECTIVE TAB -->
          <div class="tab-pane fade" id="pt-objective" role="tabpanel">
            <div class="mb-2"><label class="form-label fw-bold">Vitals:</label>
              <input type="text" class="form-control" name="vitals" id="pt_vitals"></div>
            <div class="mb-2"><label class="form-label fw-bold">Observation/Posture:</label>
              <textarea class="form-control" name="observation" id="pt_observation"></textarea></div>
            <div class="mb-2"><label class="form-label fw-bold">ROM (Active/Passive):</label>
              <textarea class="form-control" name="rom" id="pt_rom"></textarea></div>
            <div class="mb-2"><label class="form-label fw-bold">Muscle Strength:</label>
              <textarea class="form-control" name="strength" id="pt_strength"></textarea></div>
            <div class="mb-2"><label class="form-label fw-bold">Functional Mobility (Bed, Transfers, Gait):</label>
              <textarea class="form-control" name="functional_mobility" id="pt_functional_mobility"></textarea></div>
            <div class="mb-2"><label class="form-label fw-bold">Balance:</label>
              <input type="text" class="form-control" name="balance" id="pt_balance"></div>
            <div class="mb-2"><label class="form-label fw-bold">Assistive Devices:</label>
              <input type="text" class="form-control" name="assistive_devices" id="pt_assistive_devices"></div>
            <div class="mb-2"><label class="form-label fw-bold">Other Objective Findings:</label>
              <textarea class="form-control" name="objective" id="pt_objective"></textarea></div>
          </div>
          <!-- DIFF DX TAB -->
          <div class="tab-pane fade" id="pt-diffdx" role="tabpanel">
            <div class="mb-2"><label class="form-label fw-bold">Differential Diagnosis:</label>
              <textarea class="form-control" name="diffdx" id="pt_diffdx"></textarea>
              <button type="button" class="btn btn-outline-secondary btn-sm mt-2" id="pt-ai-generate-diffdx">AI Generate Diff Dx</button>
            </div>
          </div>
          <!-- ASSESSMENT SUMMARY TAB -->
          <div class="tab-pane fade" id="pt-summary" role="tabpanel">
            <div class="mb-2"><label class="form-label fw-bold">Assessment Summary:</label>
              <textarea class="form-control" name="summary" id="pt_summary"></textarea>
              <button type="button" class="btn btn-outline-secondary btn-sm mt-2" id="pt-ai-generate-summary">AI Generate Summary</button>
            </div>
          </div>
          <!-- PLAN TAB -->
          <div class="tab-pane fade" id="pt-plan" role="tabpanel">
            <div class="mb-2"><label class="form-label fw-bold">Plan of Care / Goals:</label>
              <textarea class="form-control" name="goals" id="pt_goals"></textarea>
              <button type="button" class="btn btn-outline-secondary btn-sm mt-2" id="pt-ai-generate-goals">AI Generate Goals</button>
            </div>
            <div class="mb-2"><label class="form-label fw-bold">Treatment Frequency:</label>
              <input type="text" class="form-control" name="frequency" id="pt_frequency" placeholder="e.g. 2x/week x 4 weeks"></div>
            <div class="mb-2"><label class="form-label fw-bold">Duration:</label>
              <input type="text" class="form-control" name="duration" id="pt_duration" placeholder="e.g. 4 weeks"></div>
            <div class="mb-2"><label class="form-label fw-bold">Skilled Interventions:</label>
              <textarea class="form-control" name="skilled_interventions" id="pt_skilled_interventions"></textarea>
            </div>
          </div>
        </div>
      </form>
    </div>
<script>
  // ===== PT Functions =====
  function ptGetFields() {
    const data = {};
    document.querySelectorAll('#pt-evalform [name]').forEach(el => data[el.name] = el.value);
    return data;
  }
  function ptSetStatus(msg, color='green') {
    const s = document.getElementById('pt-status-msg');
    s.textContent = msg;
    s.style.color = color;
  }

  fetch('/pt_load_template', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({template: ''})
  })
    .then(r => r.json())
    .then(names => {
      document.getElementById('pt-template-select').innerHTML =
        names.map(n => `<option>${n}</option>`).join('');
    });

  document.getElementById('pt-load-template-btn').onclick = () => {
    fetch('/pt_load_template', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({template: document.getElementById('pt-template-select').value})
    })
      .then(r => r.json())
      .then(data => {
        Object.entries(data).forEach(([k,v]) => {
          const fld = document.getElementById('pt_'+k) || document.querySelector(`#pt-evalform [name="${k}"]`);
          if (fld) fld.value = v;
        });
      });
  };

  document.getElementById('pt-ai-generate-diffdx').onclick = () => {
    ptSetStatus('Generating Diff Dx…', 'orange');
    fetch('/pt_generate_diffdx', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({fields: ptGetFields()})
    })
    .then(r => r.json())
    .then(data => {
      if (data.result) {
        document.getElementById('pt_diffdx').value = data.result;
        ptSetStatus('Done','green');
      } else if (data.error) {
        ptSetStatus('AI error: ' + data.error, 'red');
      } else {
        ptSetStatus('Unexpected AI response', 'red');
      }
    })
    .catch(() => ptSetStatus('AI error','red'));
  };

  document.getElementById('pt-ai-generate-summary').onclick = () => {
    ptSetStatus('Generating summary…', 'orange');
    fetch('/pt_generate_summary', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({fields: ptGetFields()})
    })
    .then(r => r.json())
    .then(data => {
      if (data.result) {
        document.getElementById('pt_summary').value = data.result;
        ptSetStatus('Done','green');
      } else if (data.error) {
        ptSetStatus('AI error: ' + data.error, 'red');
      } else {
        ptSetStatus('Unexpected AI response', 'red');
      }
    })
    .catch(() => ptSetStatus('AI error','red'));
  };

  document.getElementById('pt-ai-generate-goals').onclick = () => {
    ptSetStatus('Generating goals…', 'orange');
    fetch('/pt_generate_goals', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({fields: ptGetFields()})
    })
    .then(response => response.json())
    .then(data => {
      if (data.result) {
        document.getElementById('pt_goals').value = data.result;
        ptSetStatus('Done', 'green');
      } else if (data.error) {
        ptSetStatus('AI error: ' + data.error, 'red');
      } else {
        ptSetStatus('Unexpected AI response', 'red');
      }
    })
    .catch(() => ptSetStatus('AI error', 'red'));
  };

  document.getElementById('pt-generate-daily-summary').onclick = () => {
    document.getElementById('pt-daily-summary-status').textContent = 'Generating summary…';
    fetch('/pt_generate_daily_summary', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        diagnosis: document.getElementById('pt_daily_diagnosis').value,
        interventions: document.getElementById('pt_daily_interventions').value,
        tolerance: document.getElementById('pt_daily_tolerance').value,
        progress: document.getElementById('pt_daily_progress').value,
        plan: document.getElementById('pt_daily_plan').value
      })
    })
    .then(r => r.json())
    .then(data => {
      if (data.result) {
        document.getElementById('pt_daily_summary').value = data.result;
        document.getElementById('pt-daily-summary-status').textContent = 'Summary generated!';
      } else if (data.error) {
        document.getElementById('pt-daily-summary-status').textContent = 'AI error: ' + data.error;
      } else {
        document.getElementById('pt-daily-summary-status').textContent = 'Unexpected AI response';
      }
    })
    .catch(() => {
      document.getElementById('pt-daily-summary-status').textContent = 'AI error';
    });
  };
</script>
{% endblock %}
